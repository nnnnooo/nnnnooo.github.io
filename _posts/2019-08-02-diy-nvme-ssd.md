---
layout: post
title:  "攒机 - NVMe 固态"
date:   2019-08-02
---

## NVMe 固态

#### 接口

> [Wikipedia - M.2](https://en.wikipedia.org/wiki/M.2#References)

<img src="https://upload.wikimedia.org/wikipedia/commons/6/68/SATA_Express_interface.svg"/>

#### 内部基本结构

##### 1. 主控

> [如何选购固态硬盘？ - dloe 的回答](https://www.zhihu.com/question/20369676)

> [主流 NVMe SSD 主控简介](https://www.bilibili.com/read/cv712769/)

- Marvell
    [88SS1092、88SS1093](https://cn.marvell.com/storage/ssd/88ss1092-93/)
    [88SS1098、88SS1088](https://cn.marvell.com/storage/ssd/88ss10x8/)

- SandForce
    >性能也不错，它的特点是支持压缩数据，比如一个10M的可压缩数据可能被他压成5M的写入硬盘，但还是占用10M的空间，可以提高点速度，最大的特点是会延长SSD的寿命，但是主控CPU占用会高点而且速度会随着硬盘的使用逐渐小幅度降低。代表型号为SF-2281，运用在包括Intel、金士顿、威刚等品牌的SSD上。相比Marvell公司，SandForce公司这两年就有点折腾了。被LSI、Avago多次转手之后，SandForce最终于2014年落入机械硬盘厂商希捷的手中。（至于希捷好基友西数也是通过收购拓展固态硬盘业务，举债千亿收购闪迪，砸锅卖铁为君来。收购将于2016年5月12日生效。）

- Samsung
> 上一代的主控代号 Polaris（代表产品 960），就已经实现了 3GB/s 的读取速度。这一代的 Phoenix 主控更是将写入速度提高到 2GB/s 以上（代表产品 970），搭配 64 层 3D NAND，可以说几乎无敌，可惜的就是坑爹的价格，至今我还为我的那个 sm961 感觉肉疼。

- Phison
    
    | 控制 IC | 介面 | 產品型態 | 儲存容量 | NAND FLASH 類型 | 連續讀 / 寫 (up to) |
    | --: | :-- | :-- | :-- | :-- | :-- |
    | [PS5012-E12](https://www.phison.com/images/products_datasheet/Embedded-PCIe_PS5012-E12.pdf) | PCIe Gen3x4 NVMe | M.2 2280 | 256GB ~ 2048GB | 3D TLC | 3,400/3,000 MB/s |

##### 2. NAND 闪存

> [你真的懂3D NAND闪存？ | 半导体行业观察](https://zhuanlan.zhihu.com/p/48579501)

- **闪存缩放限制 Flash Memory Scaling Limit**

指无论芯片上的元件能缩小多少，闪存都无法跟上步伐。

解决的方向有:

1. 3D NAND Flash : 把存储单元立体化

2. 多层单元 (Multi-Level Cell) : 让每个存储单元不只存储ㄧ个 bit

3. 硅穿孔技术 (TSV，Through Silicon Via) : 让多颗闪存晶粒可以直接堆叠封装

- **3D NAND闪存：未来的出路**

　　NAND闪存不仅有SLC、MLC和TLC类型之分，为了进一步提高容量、降低成本，NAND的制程工艺也在不断进步，从早期的50nm一路狂奔到目前的15/16nm，但NAND闪存跟处理器不一样，先进工艺虽然带来了更大的容量，但NAND闪存的制程工艺是双刃剑，容量提升、成本降低的同时可靠性及性能都在下降，因为工艺越先进，NAND的氧化层越薄，可靠性也越差，厂商就需要采取额外的手段来弥补，但这又会提高成本，以致于达到某个点之后制程工艺已经无法带来优势了。

　　相比之下，3D NAND解决问题的思路就不一样了，为了提高NAND的容量、降低成本，厂商不需要费劲心思去提高制程工艺了，转而堆叠更多的层数就可以了，这样一来3D NAND闪存的容量、性能、可靠性都有了保证了，比如东芝的15nm NAND容量密度为1.28Gb/mm2，而三星32层堆栈的3D NAND可以轻松达到1.87Gb/mm2，48层堆栈的则可以达到2.8Gb/mm2。

　　由于已经向垂直方向扩展NAND密度，那就没有继续缩小晶体管的压力了，所以三星、Intel和美光可以使用相对更旧的工艺来生产3D NAND闪存，做成3D NAND MLC或者3D NAND TLC。现在三星已经就这样做了，850 Pro是3D MLC，850 Evo是3D TLC。使用旧工艺的好处就是P/E擦写次数大幅提升，而且电荷干扰的情况也因为使用旧工艺而大幅减少。

将平房增加楼层盖成高楼，单位面积内可容纳的人就会更多，这点是同理的。

　　三星、SK Hynix、东芝/闪迪、Intel/美光这四大NAND豪门都已经涉足3D NAND闪存了。三星最早量产了3D NAND，其他几家公司在3D NAND闪存量产上要落后三星至少2年时间。这四大豪门的3D NAND闪存所用的技术不同，堆栈的层数也不一样，而Intel在常规3D NAND闪存之外还开发了新型的3D XPoint闪存，它跟目前的3D闪存有很大不同，属于杀手锏级产品。



　　Intel本来就是做存储技术起家的。虽然现在的主业是处理器，但存储技术从来没放松。根据Intel官方说法，3D XPoint闪存各方面都超越了目前的内存及闪存，性能是普通显存的1000倍，可靠性也是普通闪存的1000倍，容量密度是内存的10倍，而且是非易失性的，断电也不会损失数据。由于还没有上市，而且Intel对3D XPoint闪存口风很严。Intel准备在2016年开始推出基于3D XPoint技术的存储产品，内存容量可达6TB，值得关注。

　　传统的平面NAND闪存现在还谈不上末路，主流工艺是15/16nm，但10/9nm节点很可能是平面NAND最后的机会了，而3D NAND闪存还会继续走下去，目前的堆栈层数不过32-48层，厂商们还在研发64层甚至更高层数的堆栈技术。3D NAND闪存在容量、速度、能效及可靠性上都有优势。

　　2D的TLC闪存由于各种问题是不会成为主流的，基本上只会有低价入门级的SSD会使用，现在的TLC SSD很多都是试验性产品，但是等到3D TLC大批量产后，它将会成为未来的主力。

- **多层单元**

　　简单来说，NAND闪存中存储的数据是以电荷的方式存储在每个NAND存储单元内的，SLC、MLC及TLC就是存储的位数不同。单层存储与多层存储的区别在于每个NAND存储单元一次所能存储的“位元数”。

　　SLC（Single-Level Cell）单层式存储每个存储单元仅能储存1bit数据，同样，MLC（Multi-Level Cell）可储存2bit数据，TLC(Trinary-Level)可储存3bit数据。一个存储单元上，一次存储的位数越多，该单元拥有的容量就越大，这样能节约闪存的成本，提高NAND的生产量。但随之而来的是，向每个单元存储单元中加入更多的数据会使得状态难以辨别，并且可靠性、耐用性和性能都会降低。

　　SLC的固态硬盘目前市面上没有，一是太贵，二是MLC足够了。

　　中高端SSD还是MLC的天下。但是MLC也有很大区别。最好的是Enterprise Synch MLC（企业级同步MLC），可靠性和寿命针对企业级市场做了优化。之后就是Synch/Toggle MLC（同步颗粒），其中**Toggle MLC**多为**东芝**出品，当然Toggle阵营中也有企业级闪存，与企业级同步MLC对应。SSD中应用比较多的其实还有Asynch MLC（异步颗粒），价格便宜量又足，不过性能比同步颗粒差。

　　由于TLC需要更精确的控制电压，那么写入数据当然也会花费更多的时间；同样的，由于需要识别8种信号，而MLC只需要识别4种，所以TLC会花更多时间来读取数据。但是和SLC比起来，MLC就被完爆了，因为SLC的电压组合只有1和0两种，与MLC的4种电压组合比起来，SLC会花费更少的时间来识别信号，同时对电压控制的要求变低：上电就是1，断电就是0，这也就解释了SLC的性能为何最好。

　　TLC闪存优点是成本低，但是带来的考验也更大。容纳的电位多了可以提升容量，但也使得整个过程更复杂，需要更精确的电压控制，Program过程所需时间更多，因此写入性能也会大幅下降，所以现在的TLC SSD都启用了SLC Cache模式提升写入速度，否则那个写入速度是很难让人接受的；读取，特别是随机读取性能也会受影响，因为需要花更多的时间从八种电信号状态中区分所需数据。另外TLC相邻的存储单元也会产生电荷干扰，20nm工艺之后，Cell单元之间的干扰现象更加严重，如果数据长时间不刷新的话就会出现像之前三星840 Evo那样的读取旧文件会掉速的现象。

　　最关键的是闪存寿命直线下降，MLC的P/E次数至少还有[3000-5000](tel:3000-5000)次，而TLC公认的P/E指标是1000次，好点的可能做到1500次，依然比MLC差很多。但各种极限测试也都证明：正常家用，TLC 120g 固态的来说用个10年左右也是不成问题，所以不必纠结寿命。更别提很多寿命更长MLC的SSD。

　　目前全球生产NAND闪存芯片的厂商屈指可数：1三星、2东芝、3闪迪、4镁光（英睿达）、5海力士、6英特尔。其中三星市场占有率第一，东芝颗粒应用最广泛。另外还有英特尔、美光、三星、闪迪多用在自家产品。海力士的量则主要是供给移动市场为主。（不过在DRAM内存市场上，主要的玩家就剩下三星、SK Hynix及美光三家了）

![](//images//ec31a8512753b2cc02aa0da85a902356_hd.jpg)

##### 3. 缓存

　　缓存对固态硬盘的影响没有前三者大，缓存和我们的手机电脑一样，也分DDR2，DDR3。固态硬盘的寻道时间很小，接近于0。因此固态硬盘的缓存并不是必要的，但写入缓存的数据不一定会直接写入到固态硬盘上，只有最终需要保存的数据才会写入到固态硬盘的FLASH芯片上，这个由程序和系统控制。没有缓存的产品也不是说寿命会很不堪，还有还有PO（7%以上）空间来维持。因此，具备较大缓存有助于减少固态硬盘上FLASH芯片的读写次数，延长了芯片的使用时间，一定程度上提高读写能力。

　　TLC SSD为了解决NAND Flash读写较慢的问题，就为产品配备了SLC Cache。在绝大多数没有达到临界值时，SLC Cache就可以全部参与为SSD读写加速。所以目前市面的TCL固态硬盘常规测试速度，均可以媲美SLC固态硬盘。但是缓存，也给TLC跑分注水造假。

　　为了真实的反映TLC SSD的性能，最简单的方法就是将测试数据区块扩大，测试数据大小大于缓存，才能让TLC真实读取性能现出原形。如三星850 EVO当遇到大量写入，持续大数据写入量的话，后劲会明显不足，用完缓存很快溢出，此时三星850 EVO就该露馅了，从400MB/S降到70MB/S甚至更小。
　　一般来说，缓存越大越好
　　
##### 4K 对齐

> [4K 对齐](https://zh.wikipedia.org/wiki/4K对齐)

如果4K不对齐，不但会极大的降低数据写入和读取速度，还会增加固态硬盘不必要的写入次数，影响寿命。非常重要。AS SSD Benchmark、DiskGenius、分区助手可检查或纠正。
[4K对齐选8，2048和4098扇区数有多大区别？实测告诉你-中关村在线硬件论坛​bbs.zol.com.cn](http://bbs.zol.com.cn/diybbs/d231_815414.html)

##### 6. 注意事项

- **分区方法：小分区、少分区**
SSD有一种技术叫做“垃圾回收机制”，TRIM 是系统用来告诉SSD主控哪些数据所占据的地址是“无效”的，而“垃圾回收机制”就是SSD内部对这些“无效”数据进行清理的过程。
SSD中的擦除只能是“将无效数据所在的整个区域摧毁”，不能像机械硬盘那样实现“点对点精确定位打击”，因此“垃圾回收机制”过程也显得很繁琐——先把区域内的有效数据集中起来，转移到空闲的位置，然后把“问题区域”整个清除，清除出来的地方可以作为下次垃圾回收时的转移地点。
所以“小分区”的概念就出来了。所谓“小分区”就是不要把SSD的容量都分满，保留一部分容量作为“空闲位置”，**用于SSD内部的优化操作，如磨损平衡、垃圾回收和坏块映射。**一般情况下这一步骤厂商已经帮我们设定好了，例如NAND容量128G的SSD，厂家会标称120G，剩下的部分就被设置成了预留空间。当然如果你十分注重SSD性能，也可以在此基础上继续增加预留空间，如：128G的固态硬盘在分区的时候只分120G或者更少。
“少分区”则是另外一种概念，关系到4k对齐对SSD的影响。一方面现在主流SSD容量都不是很大，分区越多意味着浪费的空间越多（每个分区总有那么些空间是用不到的），另一方面**分区太多容易导致分区错位，在分区边界的磁盘区域SSD性能可能受到影**响。如：128G的固态硬盘分2个分区，256G的分2-4个分区为宜。

- **保留足够的剩余空间**
固态硬盘存储越多性能越慢。而如果某个分区长期处于使用量超过90%的状态，固态硬盘崩溃的可能性将大大增加。所以及时清理无用的文件，设置合适的虚拟内存大小，将电影音乐等大文件存放到机械硬盘非常重要，必须让固态硬盘分区保留足够的剩余空间。

- 因为PCIE接口的特殊性，使用PCIE SSD作为系统盘时其启动速度会比SATA接口慢，启动时间较长。

- **关闭设备上Windows写入高速缓存缓冲区刷新**
NVMe 协议的 PCIe SSD 对 CPU 主频及内存频率要求高，且 Windows 10 系统测试 PCIe SSD 时，要在磁盘驱动器的写入缓存策略里，关闭设备上 Windows 写入高速缓存缓冲区刷新，否则无法完全发挥其性能。
